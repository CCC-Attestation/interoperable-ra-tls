Interoperable RA-TLS SGX / TDX Evidence Tags and Formats
====

# Introduction

This document defines the evidence and endorsement formats for SGX and TDX within the framework defined in the "Interoperable RA-TLS X.509 Cert and Evidence Formats" document.

# SGX / TDX Evidence CBOR Tags Registration
Three [CBOR tags](https://www.iana.org/assignments/cbor-tags/cbor-tags.xhtml#tags) haven been registered.

- CBOR tag 60000: Intel TEE quote, including all SGX and TDX ECDSA quote types
    - The quote header has fields to identify TEE type and quote format.
- CBOR tag 60001: Intel TEE report (TDX report or SGX report type 2)
    - The report header has fields to identify TEE type, subtype, and report version.
- CBOR tag 60002: SGX report (legacy, generated by EREPORT)
    - This report does not have a header to identify its type or version.

#	SGX / TDX Evidence Data Formats
SGX / TDX Evidence is an definite-length encoded tagged CBOR array with two entries, containing a TEE (SGX / TDX) quote or report, and a byte string holding custom claims.

- SGX / TDX ECDSA evidence: definite-length encoded tagged CBOR array with two entries, holding TEE quote and serialized custom claims: `60000([ TEE_ECDSA_quote(customs-buffer-hash), claims-buffer ])`
    - `claims-buffer` is a byte string of definite-length encoded CBOR map of one or two custom claims, with each claim name in text string format, and its value in byte string format.
        - Either `{ "pubkey-hash" : h'<pubkey-hash-value>'}`
        - Or `{ "pubkey-hash" : h'<pubkey-hash-value>', "nonce" : h'<nonce-value>'}`.
        - The values of the claims are defined in the "Interoperable RA-TLS X.509 Cert and Evidence Formats" document.
    - `customs-buffer-hash` held in the quote user data field is the SHA256 hash of the `claims-buffer` byte string. This hash value is small enough to fit in the SGX / TDX report user data field.
- TDX report / SGX report type 2: definite-length encoded tagged CBOR array with two entries, holding TEE report and seriealized custom claims: `60001([ TEE_report(claims-buffer-hash), claims-buffer ])`
- Legacy SGX report (generated by EREPORT): definite-length encoded tagged CBOR array with two entries, holding Legacy SGX report and serialized custome claims: `60002([ Legacy_SGX_report(claims-buffer-hash), claims-buffer ])`

SGX / TDX quote and report definitions:
- SGX / TDX ECDSA quote:
    - SGX ECDSA quote version 3 structure definition: [sgx_quote3_t](https://github.com/intel/SGXDataCenterAttestationPrimitives/blob/master/QuoteGeneration/quote_wrapper/common/inc/sgx_quote_3.h), with fields `header.version=3` and `header.att_key_type=2 or 3`.
    - SGX / TDX ECDSA version 4 structure definition: [sgx_quote4_t](https://github.com/intel/SGXDataCenterAttestationPrimitives/blob/master/QuoteGeneration/quote_wrapper/common/inc/sgx_quote_4.h), with header fields `header.version=4`, `header.tee_type=0` for SGX, and `header.tee_type=0x81` for TDX.
- TDX report:
    - Structure definition: [sgx_report2_t](https://github.com/intel/linux-sgx/blob/master/common/inc/sgx_report2.h), with field `report_mac_struct.report_type.type=0x81`.
- SGX report type 2:
    - Structure definition: [sgx_report2_t](https://github.com/intel/linux-sgx/blob/master/common/inc/sgx_report2.h), with field `report_mac_struct.report_type.type=0x00`.
- Legacy SGX report by instruction EREPORT:
    - Structure definition: [sgx_report_t](https://github.com/intel/linux-sgx/blob/master/common/inc/sgx_report.h#L113)

# SGX / TDX Endorsement Data Format

The optional endorsements extension for SGX / TDX is a byte string of definite-length encoded tagged CBOR array with 8 or 9 entries: `60000([<VERSION-as-integer>, h'<TCB_INFO>', h'<TCB_ISSUER_CHAIN>', h'<CRL_PCK_CERT>', h'<CRL_PCK_PROC_CA>', h'<CRL_ISSUER_CHAIN_PCK_CERT>', h'<QE_ID_INFO>', h'<QE_ID_ISSUER_CHAIN>', h'<CREATION_DATETIME>'])`
- Index of each entry is defined in OE SDK `oe_sgx_endorsements_fields_t`, in [bits/attestation.h](https://github.com/openenclave/openenclave/blob/master/include/openenclave/bits/attestation.h).
- The last entry, `<CREATION_DATETIME>`, is optional.
