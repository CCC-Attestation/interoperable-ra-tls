Testing between Gramine and Intel SGX SDK RA-TLS
====

# Introduction

This document records the interoperability testing between [Gramine](https://github.com/gramineproject/gramine) and [Intel SGX SDK](https://github.com/intel/linux-sgx), both of which have implemented Interoperable RA-TLS.

We conducted two sets of tests, in which Gramine and Intel SGX SDK RA-TLS respectively verified each other's certificates and established TLS secure channels. You can verify our tests by following the steps below.

# Prerequisites

## Intel SGX SDK and PSW packages

To run the tests, first you need to download and install Intel SGX SDK and corresponding PSW packages on your system. 

Interoperable RA-TLS was implemented since [Intel SGX SDK 2.22](https://github.com/intel/linux-sgx/releases/tag/sgx_2.22). 

Get Intel SGX SW packages from [Intel SGX SW repo](https://download.01.org/intel-sgx/latest/linux-latest/distro/), and install the Intel SGX SDK and PSW packages by following [Intel SGX SW Installation Guide](https://download.01.org/intel-sgx/latest/linux-latest/docs/Intel_SGX_SW_Installation_Guide_for_Linux.pdf).

# Intel SGX SDK RA-TLS as attester and Gramine as verifier

## Intel SGX SDK RA-TLS

Intel SGX SDK RA-TLS provides a sample program [SampleAttestedTLS](https://github.com/intel/linux-sgx/tree/master/SampleCode/SampleAttestedTLS), which can be used to start an RA-TLS server.


1. Get source code of SampleAttestedTLS

```sh
git clone https://github.com/intel/linux-sgx
```

2. Build the sample

```sh
cd SampleCode/SampleAttestedTLS
make
```
3. Start the server

```sh
./server/host/tls_server_host ./server/enc/tls_server_enclave.signed.so -port 4433

```

Now the tls_server_enclave listens on `127.0.0.1:4433`, with a self-signed X.509 certificate.

Here is an example certificate generated by Intel SGX SDK RA-TLS server: [intel-sgxsdk-cert.pem](./intel-sgxsdk-cert.pem)

## Gramine

Gramine provides an example program [ra-tls-mbedtls](https://github.com/gramineproject/gramine/tree/master/CI-Examples/ra-tls-mbedtls) based on mbedTLS for RA-TLS. We use the client program in it for testing.

1. Download and checkout correct Gramine version

```sh
git clone https://github.com/gramineproject/gramine.git
cd gramine/
git checkout dimakuv/interoperable-ra-tls
```

2. Build and install Gramine system-wide (in debug mode, so it can be GDBed if needed)

```sh
meson setup build-debug/ --buildtype=debug -Dskeleton=enabled -Ddirect=enabled -Dsgx=enabled -Ddcap=enabled -Dsgx_driver=upstream -Dsgx_driver_include_path=/usr/include/x86_64-linux-gnu/

ninja -C build-debug/
sudo ninja -C build-debug/ install
```

3. Build and start the RA-TLS client

```sh
cd CI-Examples/ra-tls-mbedtls/
make client
RA_TLS_ALLOW_DEBUG_ENCLAVE_INSECURE=1 RA_TLS_ALLOW_OUTDATED_TCB_INSECURE=1  ./client dcap
```

> Use `RA_TLS_ALLOW_DEBUG_ENCLAVE_INSECURE=1` to allow debug enclaves, and use `RA_TLS_ALLOW_OUTDATED_TCB_INSECURE=1` to allow outdated TCB in quote.


# Gramine as attester and Intel SGX SDK RA-TLS as verifier

## Gramine

We use the example program ra-tls-mbedtls provided by Gramine to start an RA-TLS server.

1. Download and checkout correct Gramine version

```sh
git clone https://github.com/gramineproject/gramine.git
cd gramine/
git checkout dimakuv/interoperable-ra-tls
```

2. Build and install Gramine system-wide (in debug mode, so it can be GDBed if needed)

```sh
meson setup build-debug/ --buildtype=debug -Dskeleton=enabled -Ddirect=enabled -Dsgx=enabled -Ddcap=enabled -Dsgx_driver=upstream
ninja -C build-debug/
sudo ninja -C build-debug/ install
```

3. Build and start the RA-TLS server

```sh
cd CI-Examples/ra-tls-mbedtls/
make app dcap RA_TYPE=dcap
gramine-sgx ./server
```

Now the Gramine server listens on port 4433, clients can connect to it and examine its cert.

Here is an example certificate generated by Gramine: [gramine-cert.pem](./gramine-cert.pem)

## Intel SGX SDK RA-TLS

There are 2 clients provided in Intel SGX SDK RA-TLS [SampleAttestedTLS](https://github.com/intel/linux-sgx/tree/master/SampleCode/SampleAttestedTLS), client running inside the SGX enclave([client/](https://github.com/intel/linux-sgx/tree/master/SampleCode/SampleAttestedTLS/client)) and client running in normal environment([non_enc_client/](https://github.com/intel/linux-sgx/tree/master/SampleCode/SampleAttestedTLS/non_enc_client)), both could be used to test RA-TLS connections. 

1. Get source code of SampleAttestedTLS

```sh
git clone https://github.com/intel/linux-sgx
```

2. Build the sample

```sh
cd SampleCode/SampleAttestedTLS
make
```

3. Start client
    
    - Client inside enclave
    ```sh
    ./client/host/tls_client_host ./client/enc/tls_client_enclave.signed.so -server:localhost -port:4433
    ```

    - Non-enclave client
    ```sh
    ./non_enc_client/tls_non_enc_client -server:localhost -port:4433
    ```

In both cases, the client will connect to `127.0.0.1:4433` and verify certificate of the server.
