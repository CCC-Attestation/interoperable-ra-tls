Testing between Gramine and rats-tls
====

# Introduction

This document records the interoperability testing between [Gramine](https://github.com/gramineproject/gramine) and [rats-tls](https://github.com/inclavare-containers/rats-tls), both of which have implemented Interoperable RA-TLS.

We conducted two sets of tests, in which Gramine and rats-tls respectively verified each other's certificates and established TLS secure channels. You can verify our tests by following the steps below.

# rats-tls as attester and Gramine as verifier

## rats-tls

rats-tls provides a sample program [rats-tls-server](https://github.com/inclavare-containers/rats-tls/tree/master/samples/rats-tls-server), which can be used to start an RA-TLS server.


> Note that rats-tls-server supports running in Occlum (occlum mode) or in Linux with SGX enabled (sgx mode). Here we use occlum mode as an example.

1. Get source code of rats-tls

```sh
git clone https://github.com/inclavare-containers/rats-tls
```

2. Build and install rats-tls with samples (occlum mode)

```sh
cd rats-tls

# Occlum mode
cmake -DRATS_TLS_BUILD_MODE="occlum" -DBUILD_SAMPLES=on -H. -Bbuild
make -C build install
```

3. Build Occlum container image for rats-tls-server

```sh
cd /usr/share/rats-tls/samples

# 1. Init Occlum server Workspace
rm -rf occlum_workspace_server
mkdir occlum_workspace_server
cd occlum_workspace_server
occlum init

# 2. Copy files into Occlum Workspace and Build
cp ../rats-tls-server image/bin
cp /lib/x86_64-linux-gnu/libdl.so.2 image/opt/occlum/glibc/lib
cp /usr/lib/x86_64-linux-gnu/libssl.so.1.1 image/opt/occlum/glibc/lib
cp /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1 image/opt/occlum/glibc/lib
mkdir -p image/usr/local/lib
cp -rf /usr/local/lib/rats-tls image/usr/local/lib

occlum build
```

4. Start rats-tls-server

```sh
occlum run /bin/rats-tls-server --log-level debug --ip 127.0.0.1 --port 4433 --attester sgx_ecdsa --verifier nullverifier --crypto openssl --tls openssl --endorsements
```

Now the rats-tls-server listens on `127.0.0.1:4433`, with a self-signed X.509 certificate.

Here is a certificate generated by rats-tls-server: [rats-tls-cert.pem](./rats-tls-cert.pem)

## Gramine

Gramine provides an example program [ra-tls-mbedtls](https://github.com/gramineproject/gramine/tree/master/CI-Examples/ra-tls-mbedtls) based on mbedtls for RA-TLS. We use the client program in it for testing.

1. Download and checkout correct Gramine version

```sh
git clone https://github.com/gramineproject/gramine.git
cd gramine/
git checkout dimakuv/interoperable-ra-tls
```

2. Build and install Gramine system-wide (in debug mode, so it can be GDBed if needed)

```sh
meson setup build-debug/ --buildtype=debug -Dskeleton=enabled -Ddirect=enabled -Dsgx=enabled -Ddcap=enabled -Dsgx_driver=upstream
ninja -C build-debug/
sudo ninja -C build-debug/ install
```

3. build and start the RA-TLS client

```sh
cd CI-Examples/ra-tls-mbedtls/
make client
RA_TLS_ALLOW_DEBUG_ENCLAVE_INSECURE=1 RA_TLS_ALLOW_OUTDATED_TCB_INSECURE=1  ./client dcap
```

> Use `RA_TLS_ALLOW_DEBUG_ENCLAVE_INSECURE=1` to allow debug enclaves, and use `RA_TLS_ALLOW_OUTDATED_TCB_INSECURE=1` to allow outdated TCB in quote.


# Gramine as attester and rats-tls as verifier

## Gramine

We use the example program ra-tls-mbedtls provided by Gramine to start an RA-TLS server.

1. Download and checkout correct Gramine version

```sh
git clone https://github.com/gramineproject/gramine.git
cd gramine/
git checkout dimakuv/interoperable-ra-tls
```

2. Build and install Gramine system-wide (in debug mode, so it can be GDBed if needed)

```sh
meson setup build-debug/ --buildtype=debug -Dskeleton=enabled -Ddirect=enabled -Dsgx=enabled -Ddcap=enabled -Dsgx_driver=upstream
ninja -C build-debug/
sudo ninja -C build-debug/ install
```

3. build and start the RA-TLS server

```sh
cd CI-Examples/ra-tls-mbedtls/
make app dcap RA_TYPE=dcap
gramine-sgx ./server
```

Now the Gramine server listens on port 4433, clients can connect to it and examine its cert.

Here is a certificate generated by Gramine: [gramine-cert.pem](./gramine-cert.pem)

## rats-tls

rats-tls provides a sample program, [rats-tls-client](https://github.com/inclavare-containers/rats-tls/tree/master/samples/rats-tls-client), to test RA-TLS connections. We use the rats-tls-client running in the Occlum environment as an client.

> Note that the rats-tls-client can also be run in host mode as a verifier.

1. Get source code of rats-tls

```sh
git clone https://github.com/inclavare-containers/rats-tls
```

2. Build and install rats-tls with samples (occlum mode)

```sh
cd rats-tls

# Occlum mode
cmake -DRATS_TLS_BUILD_MODE="occlum" -DBUILD_SAMPLES=on -H. -Bbuild
make -C build install
```

3. Build Occlum container image for rats-tls-client

```sh
cd /usr/share/rats-tls/samples

# 1. Init Occlum client Workspace
rm -rf occlum_workspace_client
mkdir occlum_workspace_client
cd occlum_workspace_client
occlum init

# 2. Copy files into Occlum Workspace and Build
cp ../rats-tls-client image/bin
cp /lib/x86_64-linux-gnu/libdl.so.2 image/opt/occlum/glibc/lib
cp /usr/lib/x86_64-linux-gnu/libssl.so.1.1 image/opt/occlum/glibc/lib
cp /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1 image/opt/occlum/glibc/lib
mkdir -p image/usr/local/lib
cp -rf /usr/local/lib/rats-tls image/usr/local/lib

occlum build
```

4. Start rats-tls-client

```sh
occlum run /bin/rats-tls-client --ip 127.0.0.1 --port 4433 --attester nullattester --verifier sgx_ecdsa_qve --crypto openssl --tls openssl
```

The client will connect to `127.0.0.1:4433` and verify certificate of the server.

